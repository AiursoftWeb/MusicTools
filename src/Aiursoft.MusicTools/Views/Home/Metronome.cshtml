@model Aiursoft.MusicTools.Models.HomeViewModels.MetronomeViewModel

<div class="container mt-5">
    <div class="card shadow-sm" style="max-width: 800px; margin: 0 auto;">
        <div class="card-body text-center p-5">
            <h1 class="mb-4">@Model.PageTitle</h1>
            
            <div class="mb-4">
                <div id="bpm-display" class="display-1 fw-bold text-primary">90</div>
                <div class="text-muted fs-4">BPM</div>
            </div>

            <div class="mb-5 px-md-5">
                <input type="range" class="form-range" id="bpm-slider" min="0" max="100" step="0.1" value="50" style="height: 2rem;">
                <div class="d-flex justify-content-between text-muted small mt-2">
                    <span>Slow (1)</span>
                    <span>Normal (90)</span>
                    <span>Fast (320)</span>
                </div>
            </div>

            <div class="row justify-content-center mb-5">
                <div class="col-md-5 mb-3">
                    <label for="time-signature" class="form-label fw-bold">Time Signature</label>
                    <select id="time-signature" class="form-select form-select-lg text-center">
                        <option value="1/4">1/4</option>
                        <option value="2/4">2/4</option>
                        <option value="3/4">3/4</option>
                        <option value="4/4" selected>4/4</option>
                        <option value="5/4">5/4</option>
                        <option value="6/4">6/4</option>
                        <option value="3/8">3/8</option>
                        <option value="5/8">5/8</option>
                        <option value="6/8">6/8</option>
                        <option value="7/8">7/8</option>
                        <option value="9/8">9/8</option>
                        <option value="12/8">12/8</option>
                    </select>
                </div>
                <div class="col-md-5 mb-3">
                    <label for="subdivision" class="form-label fw-bold">Subdivision</label>
                    <select id="subdivision" class="form-select form-select-lg text-center">
                        <option value="1" selected>Quarter Note (♩)</option>
                        <option value="2">Eighth Note (♫)</option>
                        <option value="3">Triplet (3)</option>
                        <option value="4">Sixteenth Note (♬)</option>
                    </select>
                </div>
            </div>

            <button id="start-stop-btn" class="btn btn-primary btn-lg px-5 py-3 rounded-pill shadow transition-all">
                <span id="btn-icon">▶</span> <span id="btn-text">Start</span>
            </button>
            
            <div class="mt-5 d-flex justify-content-center gap-3" id="visual-beats" style="min-height: 20px;">
                <!-- Dots will be generated here -->
            </div>
        </div>
    </div>
</div>

<style>
    .beat-dot {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: #e9ecef;
        transition: background-color 0.1s;
    }
    .beat-dot.active {
        background-color: #0d6efd;
        box-shadow: 0 0 10px #0d6efd;
    }
    .beat-dot.sub-active {
        background-color: #6c757d;
    }
    
    /* Custom slider styling if needed, but Bootstrap form-range is usually good */
    #bpm-slider {
        cursor: pointer;
    }
</style>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const bpmSlider = document.getElementById('bpm-slider');
            const bpmDisplay = document.getElementById('bpm-display');
            const timeSignatureSelect = document.getElementById('time-signature');
            const subdivisionSelect = document.getElementById('subdivision');
            const startStopBtn = document.getElementById('start-stop-btn');
            const btnText = document.getElementById('btn-text');
            const btnIcon = document.getElementById('btn-icon');
            const visualBeatsContainer = document.getElementById('visual-beats');

            let isPlaying = false;
            let audioContext = null;
            let nextNoteTime = 0.0;
            let currentBeat = 0;
            let currentSubBeat = 0;
            let timerID = null;
            
            // Configuration
            let bpm = 90;
            let beatsPerMeasure = 4;
            let noteValue = 4; // Denominator of time signature
            let subdivision = 1; // 1=Quarter, 2=Eighth, 3=Triplet, 4=Sixteenth

            // BPM Calculation Logic
            function calculateBpm(sliderVal) {
                // sliderVal is 0-100
                // t goes from -1 to 1
                const t = (sliderVal - 50) / 50;
                let calculatedBpm;
                if (t < 0) {
                    // Range 1 to 90
                    // t is -1 to 0
                    // t^3 is -1 to 0
                    // 90 + 89 * t^3
                    calculatedBpm = 90 + 89 * Math.pow(t, 3);
                } else {
                    // Range 90 to 320
                    // t is 0 to 1
                    // 90 + 230 * t^3
                    calculatedBpm = 90 + 230 * Math.pow(t, 3);
                }
                return Math.round(calculatedBpm);
            }

            // Reverse calculation to set slider from BPM (if needed, but we only set from slider)
            
            bpmSlider.addEventListener('input', (e) => {
                bpm = calculateBpm(e.target.value);
                bpmDisplay.textContent = bpm;
            });

            function updateConfig(e) {
                const source = e ? e.target.id : 'init';
                const tsValue = timeSignatureSelect.value;
                const ts = tsValue.split('/');
                const num = parseInt(ts[0]);
                const den = parseInt(ts[1]);
                
                let newSubdivision = parseInt(subdivisionSelect.value);

                // Logic for Compound Meters (6/8, 9/8, 12/8)
                // In compound meter, the beat is a dotted quarter note.
                // 6/8 -> 2 beats, 9/8 -> 3 beats, 12/8 -> 4 beats.
                // The natural subdivision is 3 (Eighth notes).
                if (den === 8 && (num === 6 || num === 9 || num === 12)) {
                    beatsPerMeasure = num / 3;
                    
                    // Auto-switch to Triplet (3 clicks) which represents the 8th notes in compound meter
                    if (source === 'time-signature' || source === 'init') {
                        subdivisionSelect.value = "3";
                        newSubdivision = 3;
                    }
                } else {
                    // Simple Meter
                    beatsPerMeasure = num;
                    
                    // Reset to Quarter (1 click) for simple meters if changing time signature
                    if (source === 'time-signature') {
                        subdivisionSelect.value = "1";
                        newSubdivision = 1;
                    }
                }

                noteValue = den;
                subdivision = newSubdivision;
                
                updateVisuals();
            }

            timeSignatureSelect.addEventListener('change', updateConfig);
            subdivisionSelect.addEventListener('change', updateConfig);

            function updateVisuals() {
                visualBeatsContainer.innerHTML = '';
                for (let i = 0; i < beatsPerMeasure; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'beat-dot';
                    dot.id = `beat-${i}`;
                    visualBeatsContainer.appendChild(dot);
                }
            }

            // Audio Logic
            function nextNote() {
                const secondsPerBeat = 60.0 / bpm;
                // Adjust for time signature denominator? 
                // Usually Metronome BPM is based on Quarter notes.
                // If Time Signature is x/8, usually the beat is the 8th note?
                // Or is BPM always quarter notes?
                // Standard metronomes:
                // For x/4, beat is quarter note.
                // For x/8, beat is eighth note.
                // So if 6/8, and BPM is 90, it means 90 eighth notes per minute? 
                // Or 90 dotted-quarter notes?
                // Usually for simple meters (x/4), beat is quarter.
                // For compound meters (6/8, 9/8, 12/8), beat is usually dotted quarter.
                // BUT, simple digital metronomes often just treat the denominator as the beat unit.
                // Let's assume BPM = beats per minute, where "beat" is the denominator unit.
                // Wait, if I choose 1/4, 2/4, etc, the denominator is 4.
                // If I choose 6/8, the denominator is 8.
                // If the user selects 6/8, does he expect 90 eighth notes per minute?
                // Let's assume yes for simplicity unless "beat" is defined otherwise.
                // Actually, standard practice:
                // 4/4 -> Beat is 1/4.
                // 6/8 -> Beat is 1/8 (if treating as simple count) or 3/8 (if compound).
                // Given the options include 3/8, 5/8, 7/8... these are often counted by the 8th note.
                
                // However, the subdivision logic complicates this.
                // If subdivision is 1 (Quarter), 2 (Eighth), etc.
                // If Time Signature is 6/8, and Subdivision is "Quarter", that doesn't make sense.
                // The subdivision options are: Quarter, Eighth, Triplet, Sixteenth.
                // This suggests the subdivision is relative to the "beat".
                // If the beat is a Quarter note (x/4), then Eighth is 2 per beat.
                // If the beat is an Eighth note (x/8), then "Eighth" subdivision is 1 per beat?
                
                // Let's interpret "Subdivision" as: how many clicks per beat.
                // But the options are specific note names: "Quarter", "Eighth", "Triplet", "Sixteenth".
                // This implies the "Beat" is a Quarter note?
                // If I select 6/8, maybe it just plays 6 beats.
                // Let's assume the "Beat" is always a Quarter Note for the BPM calculation, 
                // and the Time Signature just defines the measure length and accent.
                // BUT 6/8 is mathematically 3 quarter notes.
                
                // Alternative interpretation:
                // The user selects Time Signature (e.g. 4/4).
                // The user selects Subdivision (e.g. Eighth).
                // This means for every beat (1/4), we play two clicks.
                
                // What if Time Signature is 6/8?
                // Beat unit is 1/8.
                // If Subdivision is "Eighth", it matches the beat.
                // If Subdivision is "Sixteenth", it's 2 per beat.
                // If Subdivision is "Quarter", it's every 2 beats?
                
                // Let's simplify:
                // BPM always refers to the Quarter Note.
                // If Time Signature is x/4, we have x beats.
                // If Time Signature is x/8, we have x/2 quarter-note beats? No, that's confusing.
                
                // Let's stick to: BPM = Beats Per Minute.
                // The "Beat" is determined by the denominator of the Time Signature.
                // x/4 -> Beat = Quarter Note.
                // x/8 -> Beat = Eighth Note.
                
                // Subdivision:
                // If Beat is Quarter (x/4):
                //   - Quarter: 1 click per beat.
                //   - Eighth: 2 clicks per beat.
                //   - Triplet: 3 clicks per beat.
                //   - Sixteenth: 4 clicks per beat.
                
                // If Beat is Eighth (x/8):
                //   - Quarter: 0.5 clicks per beat? (Every 2 beats).
                //   - Eighth: 1 click per beat.
                //   - Triplet: 3 clicks per beat? (3 24th notes?)
                //   - Sixteenth: 2 clicks per beat.
                
                // Let's assume the subdivision options provided by the user are intended for x/4 signatures mostly,
                // or they represent the *division of the beat*.
                // "Quarter" -> 1 per beat (No subdivision)
                // "Eighth" -> 2 per beat
                // "Triplet" -> 3 per beat
                // "Sixteenth" -> 4 per beat
                
                // I will map the user's "Subdivision" selection to "Clicks Per Beat".
                // 1 -> 1
                // 2 -> 2
                // 3 -> 3
                // 4 -> 4
                
                // And I will treat the denominator of the Time Signature as the "Beat Unit".
                // So for 6/8, BPM 90 means 90 Eighth notes per minute.
                // And if Subdivision is "Eighth" (which I map to 2 clicks?? No, "Eighth" implies 1/8 note).
                
                // Re-reading user request: "Subdivision. 有四分音符、八分音符、三连音、八分音符、十六分音符。"
                // Wait, "Eighth note" is listed twice? "四分音符 (Quarter), 八分音符 (Eighth), 三连音 (Triplet), 八分音符 (Eighth??), 十六分音符 (Sixteenth)".
                // Maybe one was "Dotted Eighth"? Or just a typo.
                // I'll stick to 1, 2, 3, 4 divisions per beat.
                
                // So:
                // secondsPerBeat = 60.0 / bpm;
                // secondsPerSubBeat = secondsPerBeat / subdivision;
                
                nextNoteTime += (60.0 / bpm) / subdivision;
                
                currentSubBeat++;
                if (currentSubBeat >= subdivision) {
                    currentSubBeat = 0;
                    currentBeat++;
                    if (currentBeat >= beatsPerMeasure) {
                        currentBeat = 0;
                    }
                }
            }

            function scheduleNote(beatNumber, subBeatNumber, time) {
                // Visuals
                // We can't schedule visuals precisely with AudioContext time, so we use setTimeout/requestAnimationFrame
                // But for simplicity in this web app, we can try to sync.
                // Actually, for a metronome, we want the visual to trigger exactly when the sound plays.
                // We can use the difference between audioContext.currentTime and time to set a timeout.
                
                const osc = audioContext.createOscillator();
                const envelope = audioContext.createGain();

                let frequency = 800; // Default beat
                if (beatNumber === 0 && subBeatNumber === 0) {
                    frequency = 1200; // Downbeat (High)
                } else if (subBeatNumber === 0) {
                    frequency = 800; // Beat (Medium)
                } else {
                    frequency = 600; // Subdivision (Low/Quiet)
                }

                osc.frequency.value = frequency;
                osc.connect(envelope);
                envelope.connect(audioContext.destination);

                // Sound envelope
                envelope.gain.value = 1;
                envelope.gain.exponentialRampToValueAtTime(0.001, time + 0.05);

                osc.start(time);
                osc.stop(time + 0.05);
                
                // Visual scheduling
                const drawTime = (time - audioContext.currentTime) * 1000;
                setTimeout(() => {
                    drawBeat(beatNumber, subBeatNumber);
                }, Math.max(0, drawTime));
            }
            
            function drawBeat(beat, subBeat) {
                // Reset all
                document.querySelectorAll('.beat-dot').forEach(d => {
                    d.classList.remove('active');
                    d.classList.remove('sub-active');
                });
                
                const dot = document.getElementById(`beat-${beat}`);
                if (dot) {
                    if (subBeat === 0) {
                        dot.classList.add('active');
                    } else {
                        // Maybe flash differently for subbeats?
                        // For now, let's just flash the main beat dot but maybe smaller/different color?
                        // Or maybe we don't visualize subbeats on the dots, just the main beats.
                        // Let's visualize subbeats by flashing the current beat dot with a different color/intensity.
                        dot.classList.add('sub-active');
                    }
                }
            }

            function scheduler() {
                // while there are notes that will play this scheduler interval
                while (nextNoteTime < audioContext.currentTime + 0.1) {
                    scheduleNote(currentBeat, currentSubBeat, nextNoteTime);
                    nextNote();
                }
                timerID = window.setTimeout(scheduler, 25.0);
            }

            startStopBtn.addEventListener('click', () => {
                if (isPlaying) {
                    isPlaying = false;
                    window.clearTimeout(timerID);
                    btnText.textContent = "Start";
                    btnIcon.textContent = "▶";
                    startStopBtn.classList.remove('btn-danger');
                    startStopBtn.classList.add('btn-primary');
                } else {
                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    isPlaying = true;
                    currentBeat = 0;
                    currentSubBeat = 0;
                    nextNoteTime = audioContext.currentTime + 0.1;
                    scheduler();
                    btnText.textContent = "Stop";
                    btnIcon.textContent = "⏸";
                    startStopBtn.classList.remove('btn-primary');
                    startStopBtn.classList.add('btn-danger');
                }
            });

            // Initialize
            updateConfig();
        });
    </script>
}
