
<!-- Game Container -->
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-12">

            <!-- SCREEN 1: START SCREEN -->
            <div id="start-overlay" class="card shadow-lg border-0 mx-auto" style="max-width: 900px; min-height: 600px;">
                <div class="card-body p-4 p-md-5 d-flex flex-column align-items-center justify-content-center text-center">
                    <!-- (Content Unchanged) -->
                    <div class="mb-5">
                        <div class="display-1 text-warning mb-2">ðŸŽ¶</div>
                        <h1 class="display-5 fw-bold mb-3">@Localizer["Melody Memory"]</h1>
                        <p class="text-secondary lead">@Localizer["Listen to the melody, memorize it, and replay it on the piano."]</p>
                    </div>

                    <div class="w-100" style="max-width: 800px;">
                        <div class="row g-4 mb-5 text-start">
                             <!-- Options (Unchanged) -->
                             <div class="col-md-4">
                                <label class="text-uppercase text-secondary fw-bold small mb-3 d-block border-bottom pb-2">@Localizer["Music Style"]</label>
                                <div class="d-flex flex-column gap-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="musicStyle" id="style-c-major" value="c-major" checked>
                                        <label class="form-check-label" for="style-c-major">@Localizer["C Major"]</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="musicStyle" id="style-tonal" value="tonal">
                                        <label class="form-check-label" for="style-tonal">@Localizer["Random Key"]</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="musicStyle" id="style-atonal" value="atonal">
                                        <label class="form-check-label" for="style-atonal">@Localizer["Atonal"] <span class="badge bg-secondary opacity-50 ms-1">@Localizer["Hard"]</span></label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="musicStyle" id="style-practice" value="practice">
                                        <label class="form-check-label" for="style-practice">@Localizer["Practice"] <span class="badge bg-success opacity-50 ms-1">@Localizer["No Score"]</span></label>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <label class="text-uppercase text-secondary fw-bold small mb-3 d-block border-bottom pb-2">@Localizer["Preview"]</label>
                                <div class="d-flex flex-column gap-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="gamePreview" id="preview-scale" value="scale" checked>
                                        <label class="form-check-label" for="preview-scale">@Localizer["Scale"]</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="gamePreview" id="preview-root" value="root">
                                        <label class="form-check-label" for="preview-root">@Localizer["Root Note"]</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="gamePreview" id="preview-standard" value="standard">
                                        <label class="form-check-label" for="preview-standard">@Localizer["Standard (A4)"]</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="gamePreview" id="preview-skip" value="skip">
                                        <label class="form-check-label" for="preview-skip">@Localizer["No Preview"]</label>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <label class="text-uppercase text-secondary fw-bold small mb-3 d-block border-bottom pb-2">@Localizer["Progression"]</label>
                                <div class="d-flex flex-column gap-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="gameProgression" id="prog-note" value="prog-note" checked>
                                        <label class="form-check-label" for="prog-note">@Localizer["+1 Note / Lvl"]</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="gameProgression" id="prog-bar" value="prog-bar">
                                        <label class="form-check-label" for="prog-bar">@Localizer["+4 Notes / Lvl"]</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="gameProgression" id="prog-double" value="prog-double">
                                        <label class="form-check-label" for="prog-double">@Localizer["+8 Notes / Lvl"]</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center bg-body-tertiary p-3 rounded mb-4">
                            <span class="text-uppercase fw-bold text-secondary small">@Localizer["Difficulty Rating"]</span>
                            <span id="start-overlay-difficulty" class="fs-4 fw-bold text-primary display-font">0</span>
                        </div>

                        <button class="btn btn-warning btn-lg w-100 p-3 fs-4 fw-bold rounded-pill shadow-sm text-uppercase tracking-wider hover-scale" onclick="window.startMelodyGame()">
                            @Localizer["Start Game"]
                        </button>
                    </div>
                </div>
            </div>

            <!-- SCREEN 2: GAME AREA -->
            <div id="game-board" class="d-none w-100">
                <div class="d-flex flex-column align-items-center w-100">

                     <!-- Top Info Bar: Timer & Status -->
                     <!-- constrained width -->
                     <div class="w-100 mb-4 px-0" style="max-width: 1000px;">

                        <!-- Timer -->
                        <div class="timer-container w-100 rounded bg-body-secondary mb-4 overflow-hidden" id="timer-container" style="height: 10px;">
                            <div class="timer-bar h-100 bg-warning" id="timer-bar"></div>
                        </div>

                        <!-- Status Area -->
                        <div class="row align-items-end text-center gx-0">
                            <div class="col-md-4 text-md-start mb-3 mb-md-0">
                                <!-- Critical Msg -->
                                <div class="last-stand-indicator text-danger fw-bold text-uppercase small" style="opacity: 0; letter-spacing: 2px;">
                                    @Localizer["Critical Health"]
                                </div>
                                <div class="d-flex justify-content-center justify-content-md-start gap-2" id="lives-container" style="min-height: 32px;"></div>
                            </div>

                            <div class="col-md-4 text-center mb-3 mb-md-0">
                                <div id="ingame-rank" class="d-flex align-items-center justify-content-center gap-2" style="height: 40px; font-size: 1.5rem;"></div>
                            </div>

                            <div class="col-md-4 text-md-end">
                                <!-- Dots -->
                                <div class="d-flex justify-content-center justify-content-md-end flex-wrap gap-2" id="progress-container" style="min-height: 12px;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Piano Area -->
                    <!-- Flex Item fix: min-width 0 to prevent flex blowout, w-100 to fill available space -->
                    <div class="w-100 px-0" style="min-width: 0;">
                         <div class="row justify-content-center">
                            <div class="col-lg-12 position-relative text-center px-0">
                                <!-- Exact wrapper struct from Index.cshtml -->
                                <!-- table-responsive handles the scroll, container handles width -->
                                <div id="piano-container" class="piano-container table-responsive"></div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- SCREEN 3: GAME OVER -->
            <div id="game-over-overlay" class="card shadow-lg border-0 d-none mx-auto" style="max-width: 800px; min-height: 600px;">
                <div class="card-body p-5 d-flex flex-column align-items-center justify-content-center text-center">

                    <div class="mb-4 text-danger display-1">ðŸ’€</div>
                    <h2 class="display-4 fw-bold mb-5">@Localizer["Game Over"]</h2>

                    <div class="card bg-body-tertiary border-0 p-4 mb-5 shadow-sm w-100" style="max-width: 500px;">
                        <div class="row text-center mb-4">
                            <div class="col-6 border-end">
                                <div class="text-uppercase text-secondary small fw-bold mb-1">@Localizer["Level Reached"]</div>
                                <div class="display-6 fw-bold text-dark" id="final-level">0</div>
                            </div>
                            <div class="col-6">
                                <div class="text-uppercase text-secondary small fw-bold mb-1">@Localizer["Final Score"]</div>
                                <div class="display-6 fw-bold text-primary" id="final-total-score">0</div>
                            </div>
                        </div>

                        <div id="rank-display" class="mb-4"></div>

                        <div class="bg-body p-3 rounded text-start text-monospace small text-muted">
                            <div id="difficulty-details" class="d-flex flex-column gap-2"></div>
                            <hr class="my-2 opacity-25">
                            <div class="d-flex justify-content-between fw-bold text-dark">
                                <span>@Localizer["Calculation"]</span>
                                <span id="score-calculation"></span>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary btn-lg px-5 py-3 rounded-pill fw-bold shadow hover-scale" onclick="window.location.reload()">
                        <i class="bi bi-arrow-clockwise me-2"></i> @Localizer["Try Again"]
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Localization Data (Unchanged) -->
<div id="loc-data" hidden>
    <span data-key="notes">@Localizer["Notes"]</span>
    <span data-key="diff">@Localizer["Diff"]</span>
    <span data-key="difficulty">@Localizer["Difficulty"]</span>
    <span data-key="rookie">@Localizer["Rookie"]</span>
    <span data-key="intermediate">@Localizer["Intermediate"]</span>
    <span data-key="bronze">@Localizer["Bronze"]</span>
    <span data-key="silver">@Localizer["Silver"]</span>
    <span data-key="gold">@Localizer["Gold"]</span>
    <span data-key="diamond">@Localizer["Diamond"]</span>
    <span data-key="grandmaster">@Localizer["Grandmaster"]</span>
</div>

@* ReSharper disable once Razor.SectionNotResolved *@

@section scripts {
                                                                            <script type="module" src="~/dist/scripts/melodyMemory.js" asp-append-version="true"></script>
}
@* ReSharper disable once Razor.SectionNotResolved *@

@section styles {
                                                                            <link rel="stylesheet" href="~/styles/site.css" asp-append-version="true" />
                                                                            <style>
                                                                                .hover-scale { transition: transform 0.2s; }
                                                                                .hover-scale:hover { transform: scale(1.02); }

                                                                                .heart { font-size: 1.5rem; color: #ddd; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
                                                                                .heart.active { color: #dc3545; filter: drop-shadow(0 4px 6px rgba(220, 53, 69, 0.2)); }
                                                                                .heart.lost { color: #ddd; transform: scale(0.6); opacity: 0.5; }

                                                                                .progress-dot { width: 10px; height: 10px; background-color: #e9ecef; border-radius: 50%; transition: all 0.2s; }
                                                                                .progress-dot.filled { background-color: #0d6efd; transform: scale(1.2); }
                                                                                .progress-dot.active { background-color: #0dcaf0; box-shadow: 0 0 0 2px rgba(13, 202, 240, 0.3); }

                                                                                #piano-container.unclickable { pointer-events: none; opacity: 0.6; filter: grayscale(.2); }

                                                                                /* Timer Animation Logic: Standard simple countdown 100% -> 0% */
                                                            .timer-container { opacity: 0; }
                                                            /* Removed .active transition, now controlled by animation */

                                                            .timer-bar { width: 100%; transform-origin: left; }

                                                            /*
                                                               Logic:
                                                               1. Container: Hidden (Opacity 0) until 30% time elapsed. Then fades in.
                                                               2. Bar: Shrinks from 100% to 0% continuously.
                                                            */
                                                            @@keyframes timer-container-fade {
                                                                0% { opacity: 0; }
                                                                29% { opacity: 0; }
                                                                33% { opacity: 1; }
                                                                100% { opacity: 1; }
                                                            }

                                                            @@keyframes timer-bar-shrink {
                                                                from { width: 100%; }
                                                                to { width: 0%; }
                                                            }

                                                                                /* Rank Pop */
                                                                                .rank-emoji { font-size: 3rem; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
                                                                                @@keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

                                                                                /* NEW: Damage Effect on Piano Container - Using INSET to avoid overflow clipping */
                                                                            /* NEW: Damage Effect on PIANO (not container) */
                                                                            /* Target immediate child .piano inside container */
                                                                            #piano-container .piano.damage-effect {
                                                                                animation: pulse-red-shadow 0.6s ease-out;
                                                                            }
                                                                            @@keyframes pulse-red-shadow {
                                                                                0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
                                                                                20% { box-shadow: 0 0 30px 10px rgba(220, 53, 69, 0.8); }
                                                                                100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
                                                                            }

                                                                            /* Critical State (Last Stand) - Apply to PIANO */
                                                                            #game-board.critical .last-stand-indicator { opacity: 1 !important; }
                                                                            #game-board.critical #piano-container .piano {
                                                                                /* Constant low pulsing glow for critical state */
                                                                                box-shadow: 0 0 15px rgba(220, 53, 69, 0.5);
                                                                                animation: critical-pulse 2s infinite;
                                                                            }
                                                                            @@keyframes critical-pulse {
                                                                                0% { box-shadow: 0 0 15px rgba(220, 53, 69, 0.5); }
                                                                                50% { box-shadow: 0 0 25px 5px rgba(220, 53, 69, 0.8); }
                                                                                100% { box-shadow: 0 0 15px rgba(220, 53, 69, 0.5); }
                                                                            }

                                                                            </style>
}
